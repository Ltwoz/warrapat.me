{
  "title": "Why Did Discord Go From MongoDB To Cassandra Then ScyllaDB? Simplified!",
  "description": "Simplified some blogs published by Discord on their challenges and learning while implementing and chaining the database for their product based on the data.",
  "publishedAt": "2022-03-15T00:00:00.000Z",
  "cover": "/assets/Why-Did-Discord-Go-From-MongoDB-To-Cassandra-Then-ScyllaDB-Simplified/cover.png",
  "color": "purple",
  "body": {
    "raw": "\nHey, How are you?\n\nSo the other day I came across a Discord blog titled [HOW DISCORD STORES TRILLIONS OF MESSAGES](https://discord.com/blog/how-discord-stores-trillions-of-messages), and the title piques my interest and gives a sense of wonder that in the world they are accomplishing this and that too with scalability.\n\nSo I'm going to summarize the above blog post for you because I had to read it several times to grasp everything.\n\nSo let's get started.\n\nFirst thing First, what exactly are MongoDB, Cassandra, and ScyllaDB? What are the differences between them?\n\n1. **MongoDB**: It's a NoSQL database management system and of type document based. In Mongodb JSON-like documents are created and since it's in the NoSQL family, so it's not ACID compliant. Mongodb has Master - slave model, the data model is unstructured here thus providing support for use cases where Rich Data model is required.\n2. **Cassandra**: it also belongs NoSQL family and its data model is structured and is based on columns, which is why it falls under the wide-column store type NoSQL database. Cassandra provides high availability by having multiple Master nodes in a cluster and thus provides support for use cases where database querying is required based on the primary key and where the system is write-heavy.\n3. **ScyllaDB**: it is also a wide column store-based NoSQL database like Cassandra and is also API compatible with Amazon DynamoDB and Cassandra. The major difference between ScyllaDB and Cassandra is it is written in C++ but Cassandra is written in JAVA, and instead of relying on page-cache, it stores row-cache making it more optimized and fast than Cassandra.\n\nOk let's do some time travel come with me\n\n**Current time - May 2015**\n\nThis month Discord is launched and everything is stored in a single MongoDB replica set.\n\n**Current time - November 2015**\n\nBooom, Discord now has 100 million messages stored in DB, but guess what, the data and the index could no longer able to fit in RAM, and latency becomes unpredictable.\n\nNow what, Discord decided to migrate to a new DB and they need a database that fulfills at least these requirements:\n\n1. Linear Scalability\n2. Automatic failover\n3. Low maintenance\n4. Predictable Performance\n5. Open source\n6. Not a blob-type store\n\nBecause now the company knows some common patterns like:\n\n1. The read/write ratio on the platform is 50/50.\n2. They have broadly 3 types of groups - Voice Heavy, Private Groups, and Public Groups and all of them have different behavior for disk cache.\n3. Discord has some features in the pipeline like a pinned message, full-text search, last 30 days mentions, etc.\n\nAnd they finalized and goes with Cassandra which is suitable for the above points.\n\nNow comes the situation of how should they do data modeling.\n\nIn Mongodb they indexed the messages using channel_id and created_at.\n\nBut in Cassandra, they go with a composite primary key ((channel_id, bucket), message_id) why?\n\n1. Cassandra is a kind of KKV store where the First K stands for Partition key and the second is Clustering key.\n2. Channel_id was sufficient for the partition key, then why did they choose bucket? And what is Bucket here? See point 6.\n3. But created_at would not be sufficient for clustering, because, in a channel two messages can have the same created_at value.\n4. Since they were creating message_id which is a SnowFlake, and this 64-bit id has a composition of timestamp. Read more about Snowflake hereÂ [https://blog.twitter.com/2010/announcing-snowflake](https://blog.twitter.com/2010/announcing-snowflake)\n5. So message_id was self-sufficient for clustering.\n6. Now comes Bucket, So after the team started importing messages in Cassandra, they got some errors because of a partition size of more than 100MB.\n7. Now to make partitions less than 100MB, they need some changes in the Partition key such that the size of the partition is less than 100MB. So after studying the patterns team decided that if they bucket 10 days of messages, the partition size will be less than 100MB. That is the reason for having the Partition key as (channel_id, bucket).\n\nNow comes the time to launch Cassandra.\n\nThey did launch Cassandra but made read/write double on both MongoDB and Cassandra, to check how Cassandra is behaving with production data.\n\nBut the team got some errors and the reason for that was -\n\n1. Since Cassandra is a type of NoSQL database and provides availability over consistency. So now the problem arises if two users are performing an action on the same message and one user edits the message and the other one deletes it at the same time.\n2. Then, users were getting errors on editing.\n3. As mentioned above Cassandra provides availability over consistency, so to resolve the issue team added a validation that author_id is null(which means the message is deleted), then they create a tombstone. And this tombstone is nothing just the deleted message.\n4. And while reading the database, tombstones were skipped.\n5. And this tombstone has time to live for 10 days which was later moved to 2 days because of issues they faced with one customer after launch.\n\nHence, Discord launched and successfully make primary DB - Cassandra with a performance of less than 1 ms latency in write and less than 5 ms in read operations.\n\n**Now comes Somewhere in 2022**\n\nNow Discord touches the trillion mark with around 177 nodes of Cassandra but again DB is suffering from various issues and even latency was unpredictable.\n\nOut of various issues, the database was facing two major issues:\n\n1. **Hot Partition**: This is a term discord uses when there is a situation where high traffic comes on a specific partition which results in unbounded concurrency, leading to latency. In simple terms, let's say there are two partitions one is of a small group of friends with less read/write and the other is a widely spread public group with lots of reads/write operations since reads are more expensive than writes in Cassandra, so this hot partition situation comes up when there is a lot of reads and the specific partition falls behind and cause latency spikes in all other operations.\n2. **Garbage Collector issues**: The team also spent a lot of time tuning JVM because that also pauses the operations and causes huge latency.\n\nSo how they resolved it?\n\nWe know already that they have an option of ScyllaDB(Cassandra alternative but in C++), which will resolve GC issues. But Hot partitions can still happen in ScyllaDB as well.\n\nTo resolve this and to reduce huge traffic on the database. Discord added a data service - a layer between the API monolith server and DB Clusters.\n\nThis service is written in Rust.\n\nThis data service performs two major tasks:\n\n1. **Request Coalescing**: If multiple users are hitting the same read query then only the first query hits the DB and the tasks/query gets stored in the data service and other similar queries return values from the data service itself.\n\n   <Image\n   \talt='aa'\n   \tsrc='https://cdn.hashnode.com/res/hashnode/image/upload/v1678818194645/5a767757-fd2f-4fc5-8cca-e2c2ebcdbe9f.png'\n   />\n\n2. **Upstream of data services**: Here they implemented hash-based routing which means for each request, the data service provides a routing key. for messages its channel_id, So every query for messages in the same channel hits the same instance of data service which also prevents hot partitions.\n\n   <Image\n   \talt='aa'\n   \tsrc='https://cdn.hashnode.com/res/hashnode/image/upload/v1678818216702/93e8d044-585e-4b04-8178-5a7549d7b3d8.png'\n   />\n\nAnd, that's it.\n\nThis is how Discord handles trillions of data.\n\nOk, a small request.\n\nif you found the above stuff helpful or even bad, do let me know as feedback.\n\nYou can comment here or reach me at [@ShubhInTech](https://twitter.com/ShubhInTech)\n\nfin.\n",
    "code": "var Component=(()=>{var ca=Object.create;var A=Object.defineProperty;var da=Object.getOwnPropertyDescriptor;var ua=Object.getOwnPropertyNames;var la=Object.getPrototypeOf,ma=Object.prototype.hasOwnProperty;var G=(d,a)=>()=>(a||d((a={exports:{}}).exports,a),a.exports),fa=(d,a)=>{for(var f in a)A(d,f,{get:a[f],enumerable:!0})},Ne=(d,a,f,N)=>{if(a&&typeof a==\"object\"||typeof a==\"function\")for(let w of ua(a))!ma.call(d,w)&&w!==f&&A(d,w,{get:()=>a[w],enumerable:!(N=da(a,w))||N.enumerable});return d};var ha=(d,a,f)=>(f=d!=null?ca(la(d)):{},Ne(a||!d||!d.__esModule?A(f,\"default\",{value:d,enumerable:!0}):f,d)),ba=d=>Ne(A({},\"__esModule\",{value:!0}),d);var ge=G((ga,ye)=>{ye.exports=React});var xe=G(z=>{\"use strict\";(function(){\"use strict\";var d=ge(),a=Symbol.for(\"react.element\"),f=Symbol.for(\"react.portal\"),N=Symbol.for(\"react.fragment\"),w=Symbol.for(\"react.strict_mode\"),H=Symbol.for(\"react.profiler\"),K=Symbol.for(\"react.provider\"),Q=Symbol.for(\"react.context\"),E=Symbol.for(\"react.forward_ref\"),F=Symbol.for(\"react.suspense\"),I=Symbol.for(\"react.suspense_list\"),C=Symbol.for(\"react.memo\"),B=Symbol.for(\"react.lazy\"),Ee=Symbol.for(\"react.offscreen\"),X=Symbol.iterator,Ce=\"@@iterator\";function Se(e){if(e===null||typeof e!=\"object\")return null;var r=X&&e[X]||e[Ce];return typeof r==\"function\"?r:null}var g=d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function h(e){{for(var r=arguments.length,t=new Array(r>1?r-1:0),i=1;i<r;i++)t[i-1]=arguments[i];Re(\"error\",e,t)}}function Re(e,r,t){{var i=g.ReactDebugCurrentFrame,c=i.getStackAddendum();c!==\"\"&&(r+=\"%s\",t=t.concat([c]));var u=t.map(function(s){return String(s)});u.unshift(\"Warning: \"+r),Function.prototype.apply.call(console[e],console,u)}}var Te=!1,ke=!1,Oe=!1,Ae=!1,Fe=!1,Ie=Symbol.for(\"react.module.reference\");function Be(e){return!!(typeof e==\"string\"||typeof e==\"function\"||e===N||e===H||Fe||e===w||e===F||e===I||Ae||e===Ee||Te||ke||Oe||typeof e==\"object\"&&e!==null&&(e.$$typeof===B||e.$$typeof===C||e.$$typeof===K||e.$$typeof===Q||e.$$typeof===E||e.$$typeof===Ie||e.getModuleId!==void 0))}function Me(e,r,t){var i=e.displayName;if(i)return i;var c=r.displayName||r.name||\"\";return c!==\"\"?t+\"(\"+c+\")\":t}function J(e){return e.displayName||\"Context\"}function _(e){if(e==null)return null;if(typeof e.tag==\"number\"&&h(\"Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue.\"),typeof e==\"function\")return e.displayName||e.name||null;if(typeof e==\"string\")return e;switch(e){case N:return\"Fragment\";case f:return\"Portal\";case H:return\"Profiler\";case w:return\"StrictMode\";case F:return\"Suspense\";case I:return\"SuspenseList\"}if(typeof e==\"object\")switch(e.$$typeof){case Q:var r=e;return J(r)+\".Consumer\";case K:var t=e;return J(t._context)+\".Provider\";case E:return Me(e,e.render,\"ForwardRef\");case C:var i=e.displayName||null;return i!==null?i:_(e.type)||\"Memo\";case B:{var c=e,u=c._payload,s=c._init;try{return _(s(u))}catch{return null}}}return null}var y=Object.assign,P=0,Z,ee,ae,re,ne,te,ie;function oe(){}oe.__reactDisabledLog=!0;function Le(){{if(P===0){Z=console.log,ee=console.info,ae=console.warn,re=console.error,ne=console.group,te=console.groupCollapsed,ie=console.groupEnd;var e={configurable:!0,enumerable:!0,value:oe,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}P++}}function We(){{if(P--,P===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:y({},e,{value:Z}),info:y({},e,{value:ee}),warn:y({},e,{value:ae}),error:y({},e,{value:re}),group:y({},e,{value:ne}),groupCollapsed:y({},e,{value:te}),groupEnd:y({},e,{value:ie})})}P<0&&h(\"disabledDepth fell below zero. This is a bug in React. Please file an issue.\")}}var M=g.ReactCurrentDispatcher,L;function S(e,r,t){{if(L===void 0)try{throw Error()}catch(c){var i=c.stack.trim().match(/\\n( *(at )?)/);L=i&&i[1]||\"\"}return`\n`+L+e}}var W=!1,R;{var Ve=typeof WeakMap==\"function\"?WeakMap:Map;R=new Ve}function se(e,r){if(!e||W)return\"\";{var t=R.get(e);if(t!==void 0)return t}var i;W=!0;var c=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var u;u=M.current,M.current=null,Le();try{if(r){var s=function(){throw Error()};if(Object.defineProperty(s.prototype,\"props\",{set:function(){throw Error()}}),typeof Reflect==\"object\"&&Reflect.construct){try{Reflect.construct(s,[])}catch(v){i=v}Reflect.construct(e,[],s)}else{try{s.call()}catch(v){i=v}e.call(s.prototype)}}else{try{throw Error()}catch(v){i=v}e()}}catch(v){if(v&&i&&typeof v.stack==\"string\"){for(var o=v.stack.split(`\n`),b=i.stack.split(`\n`),l=o.length-1,m=b.length-1;l>=1&&m>=0&&o[l]!==b[m];)m--;for(;l>=1&&m>=0;l--,m--)if(o[l]!==b[m]){if(l!==1||m!==1)do if(l--,m--,m<0||o[l]!==b[m]){var p=`\n`+o[l].replace(\" at new \",\" at \");return e.displayName&&p.includes(\"<anonymous>\")&&(p=p.replace(\"<anonymous>\",e.displayName)),typeof e==\"function\"&&R.set(e,p),p}while(l>=1&&m>=0);break}}}finally{W=!1,M.current=u,We(),Error.prepareStackTrace=c}var D=e?e.displayName||e.name:\"\",we=D?S(D):\"\";return typeof e==\"function\"&&R.set(e,we),we}function Ye(e,r,t){return se(e,!1)}function $e(e){var r=e.prototype;return!!(r&&r.isReactComponent)}function T(e,r,t){if(e==null)return\"\";if(typeof e==\"function\")return se(e,$e(e));if(typeof e==\"string\")return S(e);switch(e){case F:return S(\"Suspense\");case I:return S(\"SuspenseList\")}if(typeof e==\"object\")switch(e.$$typeof){case E:return Ye(e.render);case C:return T(e.type,r,t);case B:{var i=e,c=i._payload,u=i._init;try{return T(u(c),r,t)}catch{}}}return\"\"}var k=Object.prototype.hasOwnProperty,ce={},de=g.ReactDebugCurrentFrame;function O(e){if(e){var r=e._owner,t=T(e.type,e._source,r?r.type:null);de.setExtraStackFrame(t)}else de.setExtraStackFrame(null)}function qe(e,r,t,i,c){{var u=Function.call.bind(k);for(var s in e)if(u(e,s)){var o=void 0;try{if(typeof e[s]!=\"function\"){var b=Error((i||\"React class\")+\": \"+t+\" type `\"+s+\"` is invalid; it must be a function, usually from the `prop-types` package, but received `\"+typeof e[s]+\"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.\");throw b.name=\"Invariant Violation\",b}o=e[s](r,s,i,t,null,\"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED\")}catch(l){o=l}o&&!(o instanceof Error)&&(O(c),h(\"%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).\",i||\"React class\",t,s,typeof o),O(null)),o instanceof Error&&!(o.message in ce)&&(ce[o.message]=!0,O(c),h(\"Failed %s type: %s\",t,o.message),O(null))}}}var Ue=Array.isArray;function V(e){return Ue(e)}function Ge(e){{var r=typeof Symbol==\"function\"&&Symbol.toStringTag,t=r&&e[Symbol.toStringTag]||e.constructor.name||\"Object\";return t}}function ze(e){try{return ue(e),!1}catch{return!0}}function ue(e){return\"\"+e}function le(e){if(ze(e))return h(\"The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.\",Ge(e)),ue(e)}var j=g.ReactCurrentOwner,He={key:!0,ref:!0,__self:!0,__source:!0},me,fe,Y;Y={};function Ke(e){if(k.call(e,\"ref\")){var r=Object.getOwnPropertyDescriptor(e,\"ref\").get;if(r&&r.isReactWarning)return!1}return e.ref!==void 0}function Qe(e){if(k.call(e,\"key\")){var r=Object.getOwnPropertyDescriptor(e,\"key\").get;if(r&&r.isReactWarning)return!1}return e.key!==void 0}function Xe(e,r){if(typeof e.ref==\"string\"&&j.current&&r&&j.current.stateNode!==r){var t=_(j.current.type);Y[t]||(h('Component \"%s\" contains the string ref \"%s\". Support for string refs will be removed in a future major release. This case cannot be automatically converted to an arrow function. We ask you to manually fix this case by using useRef() or createRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref',_(j.current.type),e.ref),Y[t]=!0)}}function Je(e,r){{var t=function(){me||(me=!0,h(\"%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)\",r))};t.isReactWarning=!0,Object.defineProperty(e,\"key\",{get:t,configurable:!0})}}function Ze(e,r){{var t=function(){fe||(fe=!0,h(\"%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)\",r))};t.isReactWarning=!0,Object.defineProperty(e,\"ref\",{get:t,configurable:!0})}}var ea=function(e,r,t,i,c,u,s){var o={$$typeof:a,type:e,key:r,ref:t,props:s,_owner:u};return o._store={},Object.defineProperty(o._store,\"validated\",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(o,\"_self\",{configurable:!1,enumerable:!1,writable:!1,value:i}),Object.defineProperty(o,\"_source\",{configurable:!1,enumerable:!1,writable:!1,value:c}),Object.freeze&&(Object.freeze(o.props),Object.freeze(o)),o};function aa(e,r,t,i,c){{var u,s={},o=null,b=null;t!==void 0&&(le(t),o=\"\"+t),Qe(r)&&(le(r.key),o=\"\"+r.key),Ke(r)&&(b=r.ref,Xe(r,c));for(u in r)k.call(r,u)&&!He.hasOwnProperty(u)&&(s[u]=r[u]);if(e&&e.defaultProps){var l=e.defaultProps;for(u in l)s[u]===void 0&&(s[u]=l[u])}if(o||b){var m=typeof e==\"function\"?e.displayName||e.name||\"Unknown\":e;o&&Je(s,m),b&&Ze(s,m)}return ea(e,o,b,c,i,j.current,s)}}var $=g.ReactCurrentOwner,he=g.ReactDebugCurrentFrame;function x(e){if(e){var r=e._owner,t=T(e.type,e._source,r?r.type:null);he.setExtraStackFrame(t)}else he.setExtraStackFrame(null)}var q;q=!1;function U(e){return typeof e==\"object\"&&e!==null&&e.$$typeof===a}function be(){{if($.current){var e=_($.current.type);if(e)return`\n\nCheck the render method of \\``+e+\"`.\"}return\"\"}}function ra(e){{if(e!==void 0){var r=e.fileName.replace(/^.*[\\\\\\/]/,\"\"),t=e.lineNumber;return`\n\nCheck your code at `+r+\":\"+t+\".\"}return\"\"}}var pe={};function na(e){{var r=be();if(!r){var t=typeof e==\"string\"?e:e.displayName||e.name;t&&(r=`\n\nCheck the top-level render call using <`+t+\">.\")}return r}}function _e(e,r){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var t=na(r);if(pe[t])return;pe[t]=!0;var i=\"\";e&&e._owner&&e._owner!==$.current&&(i=\" It was passed a child from \"+_(e._owner.type)+\".\"),x(e),h('Each child in a list should have a unique \"key\" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',t,i),x(null)}}function ve(e,r){{if(typeof e!=\"object\")return;if(V(e))for(var t=0;t<e.length;t++){var i=e[t];U(i)&&_e(i,r)}else if(U(e))e._store&&(e._store.validated=!0);else if(e){var c=Se(e);if(typeof c==\"function\"&&c!==e.entries)for(var u=c.call(e),s;!(s=u.next()).done;)U(s.value)&&_e(s.value,r)}}}function ta(e){{var r=e.type;if(r==null||typeof r==\"string\")return;var t;if(typeof r==\"function\")t=r.propTypes;else if(typeof r==\"object\"&&(r.$$typeof===E||r.$$typeof===C))t=r.propTypes;else return;if(t){var i=_(r);qe(t,e.props,\"prop\",i,e)}else if(r.PropTypes!==void 0&&!q){q=!0;var c=_(r);h(\"Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?\",c||\"Unknown\")}typeof r.getDefaultProps==\"function\"&&!r.getDefaultProps.isReactClassApproved&&h(\"getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.\")}}function ia(e){{for(var r=Object.keys(e.props),t=0;t<r.length;t++){var i=r[t];if(i!==\"children\"&&i!==\"key\"){x(e),h(\"Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.\",i),x(null);break}}e.ref!==null&&(x(e),h(\"Invalid attribute `ref` supplied to `React.Fragment`.\"),x(null))}}function oa(e,r,t,i,c,u){{var s=Be(e);if(!s){var o=\"\";(e===void 0||typeof e==\"object\"&&e!==null&&Object.keys(e).length===0)&&(o+=\" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.\");var b=ra(c);b?o+=b:o+=be();var l;e===null?l=\"null\":V(e)?l=\"array\":e!==void 0&&e.$$typeof===a?(l=\"<\"+(_(e.type)||\"Unknown\")+\" />\",o=\" Did you accidentally export a JSX literal instead of a component?\"):l=typeof e,h(\"React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s\",l,o)}var m=aa(e,r,t,c,u);if(m==null)return m;if(s){var p=r.children;if(p!==void 0)if(i)if(V(p)){for(var D=0;D<p.length;D++)ve(p[D],e);Object.freeze&&Object.freeze(p)}else h(\"React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.\");else ve(p,e)}return e===N?ia(m):ta(m),m}}var sa=oa;z.Fragment=N,z.jsxDEV=sa})()});var Pe=G((Da,De)=>{\"use strict\";De.exports=xe()});var Na={};fa(Na,{default:()=>va,frontmatter:()=>pa});var n=ha(Pe()),pa={title:\"Why Did Discord Go From MongoDB To Cassandra Then ScyllaDB? Simplified!\",publishedAt:\"2022-03-15\",description:\"Simplified some blogs published by Discord on their challenges and learning while implementing and chaining the database for their product based on the data.\",cover:\"/assets/Why-Did-Discord-Go-From-MongoDB-To-Cassandra-Then-ScyllaDB-Simplified/cover.png\",color:\"purple\"};function je(d){let a=Object.assign({p:\"p\",a:\"a\",ol:\"ol\",li:\"li\",strong:\"strong\"},d.components),{Image:f}=a;return f||wa(\"Image\",!0,\"99:4-102:6\"),(0,n.jsxDEV)(n.Fragment,{children:[(0,n.jsxDEV)(a.p,{children:\"Hey, How are you?\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:9,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:[\"So the other day I came across a Discord blog titled \",(0,n.jsxDEV)(a.a,{href:\"https://discord.com/blog/how-discord-stores-trillions-of-messages\",children:\"HOW DISCORD STORES TRILLIONS OF MESSAGES\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:11,columnNumber:54},this),\", and the title piques my interest and gives a sense of wonder that in the world they are accomplishing this and that too with scalability.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:11,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"So I'm going to summarize the above blog post for you because I had to read it several times to grasp everything.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:13,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"So let's get started.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:15,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"First thing First, what exactly are MongoDB, Cassandra, and ScyllaDB? What are the differences between them?\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:17,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:[(0,n.jsxDEV)(a.strong,{children:\"MongoDB\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:19,columnNumber:4},this),\": It's a NoSQL database management system and of type document based. In Mongodb JSON-like documents are created and since it's in the NoSQL family, so it's not ACID compliant. Mongodb has Master - slave model, the data model is unstructured here thus providing support for use cases where Rich Data model is required.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:19,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:[(0,n.jsxDEV)(a.strong,{children:\"Cassandra\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:20,columnNumber:4},this),\": it also belongs NoSQL family and its data model is structured and is based on columns, which is why it falls under the wide-column store type NoSQL database. Cassandra provides high availability by having multiple Master nodes in a cluster and thus provides support for use cases where database querying is required based on the primary key and where the system is write-heavy.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:20,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:[(0,n.jsxDEV)(a.strong,{children:\"ScyllaDB\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:21,columnNumber:4},this),\": it is also a wide column store-based NoSQL database like Cassandra and is also API compatible with Amazon DynamoDB and Cassandra. The major difference between ScyllaDB and Cassandra is it is written in C++ but Cassandra is written in JAVA, and instead of relying on page-cache, it stores row-cache making it more optimized and fast than Cassandra.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:21,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:19,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Ok let's do some time travel come with me\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:23,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:(0,n.jsxDEV)(a.strong,{children:\"Current time - May 2015\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:25,columnNumber:1},this)},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:25,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"This month Discord is launched and everything is stored in a single MongoDB replica set.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:27,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:(0,n.jsxDEV)(a.strong,{children:\"Current time - November 2015\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:29,columnNumber:1},this)},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:29,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Booom, Discord now has 100 million messages stored in DB, but guess what, the data and the index could no longer able to fit in RAM, and latency becomes unpredictable.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:31,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Now what, Discord decided to migrate to a new DB and they need a database that fulfills at least these requirements:\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:33,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:\"Linear Scalability\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:35,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Automatic failover\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:36,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Low maintenance\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:37,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Predictable Performance\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:38,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Open source\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:39,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Not a blob-type store\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:40,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:35,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Because now the company knows some common patterns like:\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:42,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:\"The read/write ratio on the platform is 50/50.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:44,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"They have broadly 3 types of groups - Voice Heavy, Private Groups, and Public Groups and all of them have different behavior for disk cache.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:45,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Discord has some features in the pipeline like a pinned message, full-text search, last 30 days mentions, etc.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:46,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:44,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"And they finalized and goes with Cassandra which is suitable for the above points.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:48,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Now comes the situation of how should they do data modeling.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:50,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"In Mongodb they indexed the messages using channel_id and created_at.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:52,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"But in Cassandra, they go with a composite primary key ((channel_id, bucket), message_id) why?\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:54,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:\"Cassandra is a kind of KKV store where the First K stands for Partition key and the second is Clustering key.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:56,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Channel_id was sufficient for the partition key, then why did they choose bucket? And what is Bucket here? See point 6.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:57,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"But created_at would not be sufficient for clustering, because, in a channel two messages can have the same created_at value.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:58,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:[\"Since they were creating message_id which is a SnowFlake, and this 64-bit id has a composition of timestamp. Read more about Snowflake here\\xA0\",(0,n.jsxDEV)(a.a,{href:\"https://blog.twitter.com/2010/announcing-snowflake\",children:\"https://blog.twitter.com/2010/announcing-snowflake\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:59,columnNumber:144},this)]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:59,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"So message_id was self-sufficient for clustering.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:60,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Now comes Bucket, So after the team started importing messages in Cassandra, they got some errors because of a partition size of more than 100MB.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:61,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Now to make partitions less than 100MB, they need some changes in the Partition key such that the size of the partition is less than 100MB. So after studying the patterns team decided that if they bucket 10 days of messages, the partition size will be less than 100MB. That is the reason for having the Partition key as (channel_id, bucket).\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:62,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:56,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Now comes the time to launch Cassandra.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:64,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"They did launch Cassandra but made read/write double on both MongoDB and Cassandra, to check how Cassandra is behaving with production data.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:66,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"But the team got some errors and the reason for that was -\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:68,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:\"Since Cassandra is a type of NoSQL database and provides availability over consistency. So now the problem arises if two users are performing an action on the same message and one user edits the message and the other one deletes it at the same time.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:70,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"Then, users were getting errors on editing.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:71,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"As mentioned above Cassandra provides availability over consistency, so to resolve the issue team added a validation that author_id is null(which means the message is deleted), then they create a tombstone. And this tombstone is nothing just the deleted message.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:72,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"And while reading the database, tombstones were skipped.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:73,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:\"And this tombstone has time to live for 10 days which was later moved to 2 days because of issues they faced with one customer after launch.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:74,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:70,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Hence, Discord launched and successfully make primary DB - Cassandra with a performance of less than 1 ms latency in write and less than 5 ms in read operations.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:76,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:(0,n.jsxDEV)(a.strong,{children:\"Now comes Somewhere in 2022\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:78,columnNumber:1},this)},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:78,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Now Discord touches the trillion mark with around 177 nodes of Cassandra but again DB is suffering from various issues and even latency was unpredictable.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:80,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Out of various issues, the database was facing two major issues:\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:82,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:[(0,n.jsxDEV)(a.strong,{children:\"Hot Partition\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:84,columnNumber:4},this),\": This is a term discord uses when there is a situation where high traffic comes on a specific partition which results in unbounded concurrency, leading to latency. In simple terms, let's say there are two partitions one is of a small group of friends with less read/write and the other is a widely spread public group with lots of reads/write operations since reads are more expensive than writes in Cassandra, so this hot partition situation comes up when there is a lot of reads and the specific partition falls behind and cause latency spikes in all other operations.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:84,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:[(0,n.jsxDEV)(a.strong,{children:\"Garbage Collector issues\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:85,columnNumber:4},this),\": The team also spent a lot of time tuning JVM because that also pauses the operations and causes huge latency.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:85,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:84,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"So how they resolved it?\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:87,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"We know already that they have an option of ScyllaDB(Cassandra alternative but in C++), which will resolve GC issues. But Hot partitions can still happen in ScyllaDB as well.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:89,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"To resolve this and to reduce huge traffic on the database. Discord added a data service - a layer between the API monolith server and DB Clusters.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:91,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"This service is written in Rust.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:93,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"This data service performs two major tasks:\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:95,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.ol,{children:[`\n`,(0,n.jsxDEV)(a.li,{children:[`\n`,(0,n.jsxDEV)(a.p,{children:[(0,n.jsxDEV)(a.strong,{children:\"Request Coalescing\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:97,columnNumber:4},this),\": If multiple users are hitting the same read query then only the first query hits the DB and the tasks/query gets stored in the data service and other similar queries return values from the data service itself.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:97,columnNumber:4},this),`\n`,(0,n.jsxDEV)(f,{alt:\"aa\",src:\"https://cdn.hashnode.com/res/hashnode/image/upload/v1678818194645/5a767757-fd2f-4fc5-8cca-e2c2ebcdbe9f.png\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:99,columnNumber:4},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:97,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.li,{children:[`\n`,(0,n.jsxDEV)(a.p,{children:[(0,n.jsxDEV)(a.strong,{children:\"Upstream of data services\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:104,columnNumber:4},this),\": Here they implemented hash-based routing which means for each request, the data service provides a routing key. for messages its channel_id, So every query for messages in the same channel hits the same instance of data service which also prevents hot partitions.\"]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:104,columnNumber:4},this),`\n`,(0,n.jsxDEV)(f,{alt:\"aa\",src:\"https://cdn.hashnode.com/res/hashnode/image/upload/v1678818216702/93e8d044-585e-4b04-8178-5a7549d7b3d8.png\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:106,columnNumber:4},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:104,columnNumber:1},this),`\n`]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:97,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"And, that's it.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:111,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"This is how Discord handles trillions of data.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:113,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"Ok, a small request.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:115,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"if you found the above stuff helpful or even bad, do let me know as feedback.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:117,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:[\"You can comment here or reach me at \",(0,n.jsxDEV)(a.a,{href:\"https://twitter.com/ShubhInTech\",children:\"@ShubhInTech\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:119,columnNumber:37},this)]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:119,columnNumber:1},this),`\n`,(0,n.jsxDEV)(a.p,{children:\"fin.\"},void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:121,columnNumber:1},this)]},void 0,!0,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\",lineNumber:1,columnNumber:1},this)}function _a(d={}){let{wrapper:a}=d.components||{};return a?(0,n.jsxDEV)(a,Object.assign({},d,{children:(0,n.jsxDEV)(je,d,void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\"},this)}),void 0,!1,{fileName:\"/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx\"},this):je(d)}var va=_a;function wa(d,a,f){throw new Error(\"Expected \"+(a?\"component\":\"object\")+\" `\"+d+\"` to be defined: you likely forgot to import, pass, or provide it.\"+(f?\"\\nIt\\u2019s referenced in your code at `\"+f+\"` in `/home/warrapat/Documents/Projects/warrapat.me/content/archives/_mdx_bundler_entry_point-ca75025a-8dac-48db-8fa4-fa8b84847ea2.mdx`\":\"\"))}return ba(Na);})();\n/*! Bundled license information:\n\nreact/cjs/react-jsx-dev-runtime.development.js:\n  (**\n   * @license React\n   * react-jsx-dev-runtime.development.js\n   *\n   * Copyright (c) Facebook, Inc. and its affiliates.\n   *\n   * This source code is licensed under the MIT license found in the\n   * LICENSE file in the root directory of this source tree.\n   *)\n*/\n;return Component;"
  },
  "_id": "archives/discord-mongodb-cassandra-scylladb.mdx",
  "_raw": {
    "sourceFilePath": "archives/discord-mongodb-cassandra-scylladb.mdx",
    "sourceFileName": "discord-mongodb-cassandra-scylladb.mdx",
    "sourceFileDir": "archives",
    "contentType": "mdx",
    "flattenedPath": "archives/discord-mongodb-cassandra-scylladb"
  },
  "type": "Archive",
  "slug": "/archives/discord-mongodb-cassandra-scylladb",
  "slugAsParams": "discord-mongodb-cassandra-scylladb",
  "readingTime": {
    "text": "7 min read",
    "minutes": 6.235,
    "time": 374100,
    "words": 1247
  }
}